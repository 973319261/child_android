package com.android.widgets;import android.app.Activity;import android.content.Context;import android.graphics.drawable.ColorDrawable;import android.view.LayoutInflater;import android.view.MotionEvent;import android.view.View;import android.view.View.OnClickListener;import android.view.View.OnTouchListener;import android.view.ViewGroup.LayoutParams;import android.widget.PopupWindow;import com.android.utils.DateUtil;import com.android.widgets.wheel.OnWheelChangedListener;import com.android.widgets.wheel.WheelView;import com.android.widgets.wheel.adapters.NumericWheelAdapter;import com.preschool.edu.R;import java.util.Arrays;import java.util.Calendar;import java.util.List;public class DatePicker extends PopupWindow implements OnClickListener {	public interface DatePickerChangedListener {		void datePickerChanged(String date);	}		private View view;	private String defaultDate;	private Activity INSTANCE;	private DatePickerChangedListener mDateChangedListener;	private boolean autoRefresh;	public DatePicker(Activity context, DatePickerChangedListener dateChangedListener,					  String defaultDate) {		this(context, dateChangedListener, defaultDate, true);	}	public DatePicker(Activity context, DatePickerChangedListener dateChangedListener,					  String defaultDate, final boolean autoRefresh) {		super(context);		this.INSTANCE = context;		this.mDateChangedListener = dateChangedListener;		this.defaultDate = defaultDate;		this.autoRefresh = autoRefresh;		LayoutInflater inflater = (LayoutInflater) context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);		view = inflater.inflate(R.layout.popup_pick_date, null);		view.findViewById(R.id.finish_btn).setOnClickListener(this);		yearWheel = (WheelView) view.findViewById(R.id.year);		monthWheel = (WheelView) view.findViewById(R.id.month);		dayWheel = (WheelView) view.findViewById(R.id.day);		initDateWheelView();		 //设置SelectPicPopupWindow的View          this.setContentView(view);          this.setWidth(LayoutParams.MATCH_PARENT);          this.setHeight(LayoutParams.MATCH_PARENT);          this.setFocusable(true);          this.setAnimationStyle(R.style.AnimBottom);          //实例化一个ColorDrawable颜色为半透明          ColorDrawable dw = new ColorDrawable(0xb0000000);          //设置SelectPicPopupWindow弹出窗体的背景          this.setBackgroundDrawable(dw);          view.setOnTouchListener(new OnTouchListener() {            public boolean onTouch(View v, MotionEvent event) {  				int height = view.findViewById(R.id.pop_layout).getTop();				int y = (int) event.getY();				if (event.getAction() == MotionEvent.ACTION_UP) {					if (y < height) {						if (autoRefresh) {							dateChanged();						}						dismiss();					}				}				return true;          }        });  	}		private void dateChanged(){		if (mDateChangedListener != null) {			mDateChangedListener.datePickerChanged(getCurrentDate());		}	}	@Override	public void onClick(View v) {		if (v.getId() == R.id.finish_btn) {			dateChanged();			dismiss();		}	}		private int START_YEAR = 1900, END_YEAR = 2200;	private WheelView yearWheel;	private WheelView monthWheel;	private WheelView dayWheel;	private NumericWheelAdapter dayAdapter;	private Calendar cal =  Calendar.getInstance();	private String getCurrentDate() {		int year = yearWheel.getCurrentItem() + START_YEAR;		int month = monthWheel.getCurrentItem() + 1;		int day = dayWheel.getCurrentItem() + 1;		return String.format("%d-%s-%s", year, month < 10 ? "0" + month : "" + month, day < 10 ? "0" + day : "" + day);	}	protected void initDateWheelView() {		String[] months_big = { "1", "3", "5", "7", "8", "10", "12" };		String[] months_little = { "4", "6", "9", "11" };		final List<String> list_big = Arrays.asList(months_big);		final List<String> list_little = Arrays.asList(months_little);		try {			cal.setTime(DateUtil.DATE_FORMAT.parse(this.defaultDate));		} catch (Exception e) {		}		int year = cal.get(Calendar.YEAR);		int month = cal.get(Calendar.MONTH);		int day = cal.get(Calendar.DATE);		NumericWheelAdapter yearAdapter = new NumericWheelAdapter(INSTANCE, START_YEAR, END_YEAR);		yearAdapter.setTextSize(18);		yearWheel.setViewAdapter(yearAdapter);		yearWheel.setCyclic(true);		yearWheel.setCurrentItem(year - START_YEAR);		NumericWheelAdapter monthAdapter = new NumericWheelAdapter(INSTANCE, 1, 12);		monthWheel.setViewAdapter(monthAdapter);		monthAdapter.setTextSize(18);		monthWheel.setCyclic(true);		monthWheel.setCurrentItem(month);		dayWheel.setCyclic(true);		if (list_big.contains(String.valueOf(month + 1))) {			dayAdapter = new NumericWheelAdapter(INSTANCE, 1, 31);		} else if (list_little.contains(String.valueOf(month + 1))) {			dayAdapter = new NumericWheelAdapter(INSTANCE, 1, 30);		} else {			if ((year % 4 == 0 && year % 100 != 0) || year % 400 == 0)				dayAdapter = new NumericWheelAdapter(INSTANCE, 1, 29);			else				dayAdapter = new NumericWheelAdapter(INSTANCE, 1, 28);		}		dayAdapter.setTextSize(18);		dayWheel.setViewAdapter(dayAdapter);		dayWheel.setCurrentItem(day - 1);		OnWheelChangedListener wheelListener = new OnWheelChangedListener() {			@Override			public void onChanged(WheelView wheel, int oldValue, int newValue) {				if (wheel == yearWheel) {					int year_num = newValue + START_YEAR;					if (list_big.contains(String.valueOf(monthWheel.getCurrentItem() + 1))) {						dayAdapter = new NumericWheelAdapter(INSTANCE, 1, 31);					} else if (list_little.contains(String.valueOf(monthWheel.getCurrentItem() + 1))) {						dayAdapter = new NumericWheelAdapter(INSTANCE, 1, 30);					} else {						if ((year_num % 4 == 0 && year_num % 100 != 0) || year_num % 400 == 0)							dayAdapter = new NumericWheelAdapter(INSTANCE, 1, 29);						else							dayAdapter = new NumericWheelAdapter(INSTANCE, 1, 28);					}					dayAdapter.setTextSize(18);					dayWheel.setViewAdapter(dayAdapter);				} else if (wheel == monthWheel) {					int month_num = newValue + 1;					if (list_big.contains(String.valueOf(month_num))) {						dayAdapter = new NumericWheelAdapter(INSTANCE, 1, 31);					} else if (list_little.contains(String.valueOf(month_num))) {						dayAdapter = new NumericWheelAdapter(INSTANCE, 1, 30);					} else {						if (((yearWheel.getCurrentItem() + START_YEAR) % 4 == 0								&& (yearWheel.getCurrentItem() + START_YEAR) % 100 != 0)								|| (yearWheel.getCurrentItem() + START_YEAR) % 400 == 0)							dayAdapter = new NumericWheelAdapter(INSTANCE, 1, 29);						else							dayAdapter = new NumericWheelAdapter(INSTANCE, 1, 28);					}					dayAdapter.setTextSize(18);					dayWheel.setViewAdapter(dayAdapter);				}				if (autoRefresh) {					dateChanged();				}			}		};		yearWheel.addChangingListener(wheelListener);		monthWheel.addChangingListener(wheelListener);		dayWheel.addChangingListener(wheelListener);	}}